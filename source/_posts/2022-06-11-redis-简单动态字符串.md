---
title: redis-简单动态字符串
date: 2022-06-11 10:06:05
categories:
- Redis
tags:
- redis
---
#### redis-简单动态字符串

SDS:

```
struct sdshdr{
	int len; // SDS所保存字符串的长度
	
	int free; //记录buf数组中未使用字节的数量
	
	char buf[]; //字节数组，用于保存字符串
	
	// SDS遵循C字符串以空字符结尾的惯例，保存空字符的1字节('\0')不计算再SDS的len属性里面，并且为空字符分类额外的1字节空间，以及添加空字符到字符串末尾等操作都是由SDS函数自动完成的
}
```

SDS遵循空字符串结尾这一惯例的好处，就是SDS可以重用一部分C字符串函数里面的函数



##### SDS与C字符串的区别

1.常数复杂度获取字符串的长度

SDS保存了len属性，获取字符串长度的时间复杂度为O(1)

// 设置和更新SDS长度的工作是由SDS的API在执行时自动完成的，使用SDS无需进行任何修改长度的工作

2.杜绝缓冲区溢出

C字符串不记录自身长度带来的另一个问题就是容易造成缓冲区溢出，比如使用strcat,strcpy等函数

当SDS的API需要对SDS进行修改时，API会检查SDS的空间是否满足修改所需的要求，如果不满足，API会自动将SDS的空间扩展到修改所需的大小，然后才执行实际的修改操作

比如：SDS中的sdcat函数

3.减少修改字符串时带来的内存重分配次数

SDS通过使用未使用空间解除了字符串长度和底层数组长度之间的关联

**所以SDS中buf数组的长度不一定是字符数量+1**

###### 空间预分配：当需要对SDS进行空间扩展的时候，程序不仅会为SDS分配修改所必需要的空间，还会为SDS分配额外的未使用空间

1. 如果修改之后，SDS的长度小于1MB,那么程序分配和len属性同样大小的未使用空间
2. 如果SDS长度大于等于1MB,那么程序会分配1MB的未使用空间

###### 惰性空间释放：当SDS需要缩短SDS保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用free属性来讲这些数量记录下来，等待将来使用

通过惰性空间释放，SDS避免了缩短字符串时所需的内存重分配操作，并为将来可能由的增长操作提供了优化，

SDS也提供了API，让我们在有需要的时候，真正释放SDS的未使用空间

4.二进制安全

C字符串中的字符必须符合某种编码，并且处理字符串的末尾之外，字符串里面不能包含空字符，否则最先被程序读入的空字符串被误认为是字符串结尾，这些限制使得C字符串只能保存文本数量，不能保存图片、音频、压缩文件这样的二进制数据

SDS使用len属性的值而不是空字符来判断字符串是否结束

5.兼容C字符函数

SDS总会在buf数组分配空间时多分配一个字节来容纳这个空字符，这是为了让那些保存**文本数据**的SDS可以重用一部分string.h库定义的函数
